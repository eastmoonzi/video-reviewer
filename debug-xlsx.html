<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Excel Debug Tool</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        .row-info { margin: 20px 0; padding: 15px; border: 1px solid #ccc; background: #f9f9f9; }
        .row-info h3 { margin-top: 0; color: #333; }
        .json-preview { background: #fff; padding: 10px; border: 1px solid #ddd; max-height: 300px; overflow: auto; white-space: pre-wrap; word-break: break-all; font-size: 12px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Excel 解析调试工具</h1>
    <p>选择 xlsx 文件查看每行的解析情况：</p>
    <input type="file" id="file-input" accept=".xlsx,.xls">
    <div id="output"></div>

    <script>
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array', raw: false });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: '' });

                    let html = `<p>总行数: ${rows.length}</p>`;
                    
                    // 检查是否有表头
                    const firstRow = rows[0];
                    const hasHeader = typeof firstRow[0] === 'string' && 
                        (firstRow[0].toLowerCase() === 'video_url' || 
                         firstRow[0].toLowerCase() === 'url');
                    
                    html += `<p>检测到表头: ${hasHeader ? '是' : '否'}</p>`;
                    
                    const dataRows = hasHeader ? rows.slice(1) : rows;
                    
                    dataRows.forEach((row, i) => {
                        const rowNum = hasHeader ? i + 2 : i + 1; // Excel行号
                        const taskNum = i + 1; // 任务编号
                        
                        html += `<div class="row-info">`;
                        html += `<h3>任务 ${taskNum} (Excel第${rowNum}行)</h3>`;
                        
                        // 第一列：URL
                        const url = row[0]?.toString().trim() || '';
                        html += `<p><strong>URL (第1列):</strong> ${url ? url.substring(0, 100) + (url.length > 100 ? '...' : '') : '<span class="error">空</span>'}</p>`;
                        
                        // 第二列：JSON
                        const jsonCell = row[1];
                        html += `<p><strong>JSON (第2列) 原始长度:</strong> ${jsonCell ? jsonCell.toString().length : 0} 字符</p>`;
                        
                        if (jsonCell) {
                            let jsonStr = jsonCell.toString();
                            
                            // 显示原始内容前200字符
                            html += `<p><strong>原始内容前200字符:</strong></p>`;
                            html += `<div class="json-preview">${escapeHtml(jsonStr.substring(0, 200))}</div>`;
                            
                            // 尝试解析
                            try {
                                // 处理转义
                                jsonStr = jsonStr.replace(/""/g, '"');
                                if (jsonStr.startsWith("'") && jsonStr.endsWith("'")) {
                                    jsonStr = jsonStr.slice(1, -1);
                                }
                                jsonStr = jsonStr.replace(/^\uFEFF/, '').trim();
                                
                                const parsed = JSON.parse(jsonStr);
                                html += `<p class="success">✓ JSON 解析成功</p>`;
                                
                                // 检查 segment_detail
                                if (parsed.segment_detail) {
                                    html += `<p class="success">✓ 找到 segment_detail，共 ${parsed.segment_detail.length} 个片段</p>`;
                                } else if (parsed.segments) {
                                    html += `<p class="success">✓ 找到 segments，共 ${parsed.segments.length} 个片段</p>`;
                                } else {
                                    html += `<p class="error">✗ 未找到 segment_detail 或 segments 字段</p>`;
                                    html += `<p>顶层字段: ${Object.keys(parsed).join(', ')}</p>`;
                                }
                            } catch (err) {
                                html += `<p class="error">✗ JSON 解析失败: ${err.message}</p>`;
                                
                                // 尝试找出错误位置
                                const match = err.message.match(/position (\d+)/);
                                if (match) {
                                    const pos = parseInt(match[1]);
                                    const start = Math.max(0, pos - 50);
                                    const end = Math.min(jsonStr.length, pos + 50);
                                    html += `<p><strong>错误位置附近内容 (位置${pos}):</strong></p>`;
                                    html += `<div class="json-preview">${escapeHtml(jsonStr.substring(start, pos))}<span style="background:red;color:white;">【错误位置】</span>${escapeHtml(jsonStr.substring(pos, end))}</div>`;
                                }
                            }
                        } else {
                            html += `<p class="error">✗ 第2列为空，没有JSON数据</p>`;
                        }
                        
                        html += `</div>`;
                    });

                    document.getElementById('output').innerHTML = html;
                } catch (err) {
                    document.getElementById('output').innerHTML = `<p class="error">文件读取失败: ${err.message}</p>`;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
    </script>
</body>
</html>